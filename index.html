<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur - Liste d'item D&D e3.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        select, input[type="file"], button {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<h2>Générateur - Liste d'item D&D e3.5</h2>

<!-- Sélecteur de fichier CSV -->
<input type="file" id="csvFileInput" accept=".csv" onchange="loadCSVData(event)"><br>

<!-- Menu déroulant pour sélectionner la colonne de probabilités -->
<select id="filterColumn" onchange="generateTable()">
    <!-- Les options seront générées dynamiquement -->
</select>

<!-- Bouton pour générer la liste aléatoire -->
<button onclick="generateRandomList()">Générer Liste Aléatoire</button>

<table id="itemsTable">
    <thead>
        <tr>
            <th>Nom de l'article</th>
            <th>Prix</th>
            <th>Qté</th>
            <th>Détails</th>
        </tr>
    </thead>
    <tbody>
        <!-- Les lignes du tableau seront générées ici -->
    </tbody>
</table>

<script>
let csvData = []; 

// Fonction pour charger et parser le fichier CSV
function loadCSVData(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const text = e.target.result;
        // Utilisation de PapaParse pour parser le CSV
        const data = Papa.parse(text, {
            header: true, // Les en-têtes du CSV seront utilisés comme noms de colonnes
            skipEmptyLines: true, // Ignorer les lignes vides
            complete: function(results) {
                csvData = results.data; // Stocker les données parsées dans csvData
                generateColumnOptions(); // Mettre à jour le menu déroulant avec les nouvelles colonnes
                generateTable(); // Générer immédiatement le tableau avec les options actuelles
            }
        });
    };
    
    reader.readAsText(file); // Lire le fichier comme texte
}

// Fonction pour générer dynamiquement les options du menu déroulant
function generateColumnOptions() {
    const selectElement = document.getElementById('filterColumn');
    selectElement.innerHTML = ''; // Vider les options existantes

    if (csvData.length === 0) return; // Si aucune donnée, ne rien faire

    const columns = Object.keys(csvData[0]); // Extraire les noms des colonnes
    // Les options des colonnes à partir de la colonne 5 et plus
    for (let i = 4; i < columns.length; i++) {
        const option = document.createElement('option');
        option.value = i; // La colonne 5 a l'index 4, etc.
        option.textContent = columns[i]; // Nom de la colonne (probabilité)
        selectElement.appendChild(option);
    }
}

// Fonction pour générer le tableau en fonction de la colonne sélectionnée
function generateTable() {
    const selectedColumn = parseInt(document.getElementById("filterColumn").value);
    const tbody = document.querySelector("#itemsTable tbody");
    tbody.innerHTML = ''; // Vider le tableau existant

    if (selectedColumn === undefined || csvData.length === 0) return;

    csvData.forEach(item => {
        const ARTICLE = item["ARTICLE"];
        const PRIX = item["PRIX"];
        const QTE = parseInt(item["QTE"]);
        const DETAILS = item["DETAILS"];
        const probability = parseInt(item[Object.keys(item)[selectedColumn]]); // Probabilité selon la colonne sélectionnée

        const randomChance = Math.random() * 100; // Générer une chance aléatoire entre 0 et 100

        // Si l'article doit être inclus en fonction de la probabilité
        if (randomChance <= probability) {
            const randomQty = Math.floor(Math.random() * QTE) + 1; // Quantité aléatoire entre 1 et la quantité maximale

            // Créer une ligne pour l'article
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${ARTICLE}</td>
                <td>${PRIX}</td>
                <td>${randomQty}</td>
                <td>${DETAILS}</td>
            `;
            tbody.appendChild(row);
        }
    });
}


    generateTable(); // Re-génère le tableau basé sur la colonne sélectionnée et la probabilité
}   
</script>

</body>
</html>
